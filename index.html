<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PWA Notes Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class", // Enable class-based dark mode
        theme: {
          extend: {
            colors: {
              "note-yellow": "#fff475",
              "note-blue": "#a7ffeb",
              "note-green": "#ccff90",
              "note-red": "#f28b82",
              primary: "#FFD700", // Gold/Yellow accent color
              "dark-bg": "#202124",
              "dark-card": "#3c4043",
              "light-bg": "#f7f7f7",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <!-- Link to manifest for PWA installation -->
    <link rel="manifest" href="/manifest.json" />
    <style>
      /* Custom CSS for the Masonry Grid effect and overall layout */
      body {
        background-color: var(--body-bg, #f6f8fb);
        background-image: radial-gradient(circle at 20% 20%, #fff4d6 0, transparent 35%),
          radial-gradient(circle at 80% 0%, #e0f2ff 0, transparent 45%),
          radial-gradient(circle at 0% 80%, #fce5f1 0, transparent 35%);
        font-family: "Inter", sans-serif;
        min-height: 100vh;
        color: #1f2937; /* Default text color */
      }

      /* Dark Mode Specific Styles */
      .dark {
        --body-bg: #121212;
        color: #e5e7eb; /* Light text in dark mode */
      }
      .dark main {
        background-color: #121212;
      }
      .dark #sidebar {
        background-color: #1f2937;
        border-color: #374151;
        box-shadow: none;
      }
      .dark .note-card {
        border-color: #374151;
      }
      .dark .bg-white {
        background-color: #374151 !important; /* Override white bg for notes in dark mode */
      }
      .dark .bg-note-yellow,
      .dark .bg-note-blue,
      .dark .bg-note-green,
      .dark .bg-note-red {
        /* Adjust colors to be slightly muted in dark mode */
        filter: brightness(0.85);
      }

      /* Responsive grid columns */
      .notes-grid {
        column-count: 1;
        column-gap: 1rem;
      }
      @media (min-width: 640px) {
        /* sm */
        .notes-grid {
          column-count: 2;
        }
      }
      @media (min-width: 1024px) {
        /* lg */
        .notes-grid {
          column-count: 3;
        }
      }
      @media (min-width: 1280px) {
        /* xl */
        .notes-grid {
          column-count: 4;
        }
      }

      .note-card {
        break-inside: avoid;
        margin-bottom: 1rem;
        display: inline-block; /* Essential for masonry */
        width: 100%;
      }

      .quick-chip {
        padding: 0.65rem 1.5rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        backdrop-filter: blur(14px);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
      }
      .quick-chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      .quick-chip--view {
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: #475569;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      }
      .quick-chip--view[aria-pressed="true"] {
        background: #111827;
        color: #fff;
        border-color: transparent;
        box-shadow: 0 20px 35px rgba(17, 24, 39, 0.35);
      }
      .dark .quick-chip--view {
        background: rgba(31, 41, 55, 0.65);
        border-color: rgba(148, 163, 184, 0.35);
        color: #e5e7eb;
      }
      .dark .quick-chip--view[aria-pressed="true"] {
        background: #fde68a;
        color: #1f2937;
        border-color: transparent;
      }

      /* Hide scrollbar for aesthetics */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
    </style>
  </head>
  <body class="flex">
    <!-- 1. Left Sidebar Navigation (Desktop/Tablet) -->
    <aside
      id="sidebar"
      class="hidden lg:flex flex-col w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 h-screen sticky top-0"
    >
      <div class="p-6 pb-2">
        <div class="flex items-center space-x-3">
          <div class="p-2 bg-blue-500/10 rounded-xl">
            <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <h1 class="text-xl font-bold text-gray-800 dark:text-white">Note App</h1>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Organize your thoughts</p>
      </div>
      <nav class="space-y-1 p-4">
        <!-- Notes View Link -->
        <a
          href="#"
          id="nav-notes"
          onclick="setView('notes')"
          class="flex items-center space-x-3 px-4 py-3 rounded-xl bg-blue-50 dark:bg-blue-500/10 text-blue-700 dark:text-blue-400 transition-all duration-200"
        >
          <span class="p-2 bg-blue-100 dark:bg-blue-500/20 rounded-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </span>
          <span class="font-medium">Notes</span>
        </a>

        <!-- Archive View Link -->
        <a
          href="#"
          id="nav-archive"
          onclick="setView('archive')"
          class="flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-200 text-gray-700 dark:text-gray-300"
        >
          <span class="p-2 bg-gray-100 dark:bg-gray-700/50 rounded-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 12a2 2 0 110-4h14a2 2 0 110 4m0 0H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2"></path>
            </svg>
          </span>
          <span class="font-medium">Archive</span>
          </svg>
          <span>Archive</span>
        </a>

        <!-- Settings View Link -->
        <a
          href="#"
          id="nav-settings"
          onclick="setView('settings')"
          class="flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-200 text-gray-700 dark:text-gray-300"
        >
          <span class="p-2 bg-gray-100 dark:bg-gray-700/50 rounded-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </span>
          <span class="font-medium">Settings</span>
        </a>
      </nav>
      <div
        id="user-info"
        class="p-4 text-xs text-gray-500 dark:text-gray-500 border-t mt-4 border-gray-200 dark:border-gray-700"
      >
        User ID: <span id="current-user-id">Loading...</span>
      </div>
    </aside>

    <!-- 2. Main Content Area -->
    <main class="flex-1 overflow-auto h-screen">
      <!-- Desktop Header -->
      <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div class="px-6 py-3 flex items-center justify-between">
          <!-- Search Bar -->
          <div class="relative flex-1 max-w-xl">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <input
              type="text"
              id="search-notes"
              placeholder="Search notes..."
              class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          
          <!-- User Menu -->
          <div class="ml-4 flex items-center">
            <div class="relative">
              <button
                type="button"
                class="flex items-center max-w-xs rounded-full bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                id="user-menu-button"
                aria-expanded="false"
                aria-haspopup="true"
              >
                <span class="sr-only">Open user menu</span>
                <div class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold">
                  U
                </div>
              </button>
              
              <!-- Dropdown menu (hidden by default) -->
              <div class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none z-50" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1">
                <div class="py-1" role="none">
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem" tabindex="-1" id="user-menu-item-0">Your Profile</a>
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem" tabindex="-1" id="user-menu-item-1">Settings</a>
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem" tabindex="-1" id="user-menu-item-2">Sign out</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>
      
      <div class="p-4 md:p-8 bg-light-bg dark:bg-dark-bg">
        <section
          id="notes-dashboard-shell"
          class="max-w-5xl mx-auto space-y-8 transition-opacity duration-300"
        >
          <div
            id="notes-intro"
            class="w-full rounded-[36px] bg-white dark:bg-dark-card shadow-[0_30px_80px_rgba(15,23,42,0.18)] ring-1 ring-black/5 overflow-hidden"
          >
            <div class="p-8 md:p-10">
              <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
                <div>
                  <p class="uppercase tracking-[0.35em] text-xs text-gray-400">
                    Creative workspace
                  </p>
                  <h2 class="text-4xl md:text-5xl font-black text-gray-900 dark:text-white mt-4">
                    Project Alpha Notes
                  </h2>
                  <p class="text-lg text-gray-500 dark:text-gray-300 mt-3">
                    Start typing your thoughts, align the team, and keep every insight in one beautiful place.
                  </p>
                </div>
                <div class="self-end md:self-start text-right">
                  <p class="text-xs font-semibold text-gray-400 uppercase">Status</p>
                  <p class="text-sm text-gray-600 dark:text-gray-300">Saved — just now</p>
                </div>
              </div>
              <div class="grid md:grid-cols-2 gap-6 mt-10">
                <div>
                  <p class="text-sm font-semibold text-gray-400 uppercase mb-2">
                    Objective
                  </p>
                  <p class="text-xl font-semibold text-gray-900 dark:text-white">
                    Launch the refreshed Note App experience
                  </p>
                </div>
                <div>
                  <p class="text-sm font-semibold text-gray-400 uppercase mb-2">
                    Key Results
                  </p>
                  <div class="space-y-3 bg-gray-50 dark:bg-gray-800/40 border border-gray-100 dark:border-gray-700 rounded-2xl p-4">
                    <div class="flex items-start gap-3 text-gray-700 dark:text-gray-200">
                      <span class="mt-1.5 w-2 h-2 rounded-full bg-yellow-400 shadow-[0_0_0_5px_rgba(251,191,36,0.25)]"></span>
                      <span>Research emerging note-taking trends</span>
                    </div>
                    <div class="flex items-start gap-3 text-gray-700 dark:text-gray-200">
                      <span class="mt-1.5 w-2 h-2 rounded-full bg-blue-400 shadow-[0_0_0_5px_rgba(96,165,250,0.3)]"></span>
                      <span>Craft high-fidelity wireframes & micro-interactions</span>
                    </div>
                    <div class="flex items-start gap-3 text-gray-700 dark:text-gray-200">
                      <span class="mt-1.5 w-2 h-2 rounded-full bg-green-400 shadow-[0_0_0_5px_rgba(74,222,128,0.3)]"></span>
                      <span>Validate with users & iterate based on feedback</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-10 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center gap-4 text-gray-400">
                  <div class="flex items-center gap-2 text-gray-500">
                    <span class="font-semibold text-lg">B</span>
                    <span class="italic text-lg">I</span>
                    <span class="text-2xl">•</span>
                    <span class="text-lg">#</span>
                  </div>
                  <span class="text-sm text-gray-500 dark:text-gray-400">
                    Beautiful typography + quick formatting shortcuts
                  </span>
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                  <button
                    onclick="toggleDarkMode()"
                    class="border border-gray-200 dark:border-gray-700 px-5 py-3 rounded-full text-sm font-semibold text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition"
                  >
                    Toggle Theme
                  </button>
                  <button
                    onclick="openEditor()"
                    class="bg-primary hover:bg-yellow-400 text-gray-900 font-semibold py-3 px-8 rounded-full shadow-lg shadow-yellow-200/70 transition duration-200"
                  >
                    Create Note →
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="grid gap-4 md:grid-cols-3" id="notes-stats">
            <div class="rounded-3xl bg-white dark:bg-dark-card shadow-lg shadow-slate-200/60 dark:shadow-black/20 p-5 border border-white/60 dark:border-gray-700">
              <p class="text-sm text-gray-500 dark:text-gray-400">Active Notes</p>
              <p id="stat-active" class="text-4xl font-extrabold text-gray-900 dark:text-white mt-2">0</p>
              <span class="text-xs text-emerald-500 font-semibold mt-1 inline-block">Live ideas</span>
            </div>
            <div class="rounded-3xl bg-white dark:bg-dark-card shadow-lg shadow-slate-200/60 dark:shadow-black/20 p-5 border border-white/60 dark:border-gray-700">
              <p class="text-sm text-gray-500 dark:text-gray-400">Archived</p>
              <p id="stat-archived" class="text-4xl font-extrabold text-gray-900 dark:text-white mt-2">0</p>
              <span class="text-xs text-blue-500 font-semibold mt-1 inline-block">Reference shelf</span>
            </div>
            <div class="rounded-3xl bg-white dark:bg-dark-card shadow-lg shadow-slate-200/60 dark:shadow-black/20 p-5 border border-white/60 dark:border-gray-700">
              <p class="text-sm text-gray-500 dark:text-gray-400">Total Notes</p>
              <p id="stat-total" class="text-4xl font-extrabold text-gray-900 dark:text-white mt-2">0</p>
              <span class="text-xs text-purple-500 font-semibold mt-1 inline-block">All captures</span>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-3">
            <button
              data-view-chip="notes"
              onclick="setView('notes')"
              aria-pressed="true"
              class="quick-chip quick-chip--view"
              id="chip-notes"
            >
              Active Notes
            </button>
            <button
              data-view-chip="archive"
              onclick="setView('archive')"
              aria-pressed="false"
              class="quick-chip quick-chip--view"
              id="chip-archive"
            >
              Archive
            </button>
            <button
              data-view-chip="settings"
              onclick="setView('settings')"
              aria-pressed="false"
              class="quick-chip quick-chip--view"
              id="chip-settings"
            >
              Settings
            </button>
            <button
              onclick="openEditor()"
              class="quick-chip bg-yellow-100 hover:bg-yellow-200 text-yellow-900 border border-yellow-200 shadow-[0_10px_30px_rgba(251,191,36,0.4)]"
            >
              Quick Capture
            </button>
          </div>
        </section>
      </div>

      <!-- Notes Grid -->
      <div
        id="notes-list"
        class="notes-grid w-full max-w-5xl mx-auto transition-all duration-300"
      ></div>
      <div
        class="text-center p-8 text-gray-500 max-w-5xl mx-auto"
        id="loading-message"
      >
        Loading notes...
      </div>
      <div
        class="text-center p-8 text-gray-500 hidden max-w-5xl mx-auto"
        id="no-notes-message"
      >
        You have no notes yet. Click "+ New Note" to start!
      </div>
      <button
        id="floating-note-btn"
        onclick="openEditor()"
        class="fixed bottom-6 right-6 md:bottom-10 md:right-10 bg-primary text-gray-900 font-semibold px-5 py-4 rounded-full shadow-2xl shadow-yellow-300/70 hover:bg-yellow-400 transition duration-200 flex items-center gap-2 z-40"
      >
        <span class="hidden sm:inline">Create Note</span>
        <span class="sm:hidden text-2xl leading-none">+</span>
      </button>

      <!-- Settings Content -->
      <div
        id="settings-content"
        class="hidden w-full max-w-2xl mx-auto bg-white dark:bg-dark-card rounded-xl shadow-lg p-6 md:p-8 mt-6"
      >
        <h2
          class="text-3xl font-extrabold mb-8 text-gray-800 dark:text-gray-200 border-b pb-3 border-gray-200 dark:border-gray-700"
        >
          Application Settings
        </h2>

        <!-- Dark Mode Toggle -->
        <div
          class="flex items-center justify-between py-4 border-b border-gray-100 dark:border-gray-700"
        >
          <label
            for="dark-mode-toggle"
            class="text-lg font-medium text-gray-700 dark:text-gray-300"
            >Dark Mode</label
          >
          <!-- Toggle Switch -->
          <button
            id="dark-mode-toggle"
            onclick="toggleDarkMode()"
            class="relative inline-flex flex-shrink-0 h-7 w-12 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-offset-gray-900"
            role="switch"
            aria-checked="false"
          >
            <span
              id="dark-mode-slider"
              aria-hidden="true"
              class="pointer-events-none inline-block h-6 w-6 transform rounded-full bg-white dark:bg-gray-800 shadow ring-0 transition duration-200 ease-in-out translate-x-0"
            ></span>
          </button>
        </div>

        <!-- Export Data Section -->
        <div class="py-4 border-b border-gray-100 dark:border-gray-700">
          <h3 class="text-xl font-medium text-gray-700 dark:text-gray-300 mb-2">
            Data Management
          </h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
            Export all your current notes and archived notes as a JSON file.
          </p>
          <button
            onclick="exportNotes()"
            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg shadow-md transition duration-200 flex items-center justify-center space-x-2"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>
            <span>Export All Notes (JSON)</span>
          </button>
          <p
            id="export-message"
            class="mt-2 text-sm text-green-600 hidden text-center"
          ></p>

          <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
            <h3
              class="text-xl font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Danger Zone
            </h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
              Permanently delete all your notes. This action cannot be undone.
            </p>
            <button
              onclick="if(confirm('⚠️ WARNING: This will permanently delete ALL your notes.\n\nThis action cannot be undone!')) { deleteAllNotes(); }"
              class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg shadow-md transition duration-200 flex items-center justify-center space-x-2"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                ></path>
              </svg>
              <span>Delete All Notes</span>
            </button>
            <p
              id="delete-all-message"
              class="mt-2 text-sm text-red-600 hidden text-center"
            ></p>
          </div>
        </div>

        <!-- Account Info Section -->
        <nav class="space-y-2 p-4">
          <h3 class="text-xl font-medium text-gray-700 dark:text-gray-300 mb-2">
            Account Info
          </h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            Current User Identifier (for data access):
          </p>
          <code
            class="block mt-2 p-2 bg-gray-100 dark:bg-gray-800 rounded-lg text-xs font-mono break-all text-gray-800 dark:text-gray-300"
            id="settings-user-id-display"
            >Loading...</code
          >
        </nav>
      </div>
    </main>

    <!-- 3. Note Editor Modal (Hidden by Default) -->
    <div
      id="note-editor-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden"
    >
      <div
        class="bg-white dark:bg-dark-card w-full max-w-lg mx-4 rounded-lg shadow-2xl overflow-hidden transform transition-all scale-100 note-card"
        style="min-height: 300px"
        id="editor-card"
      >
        <div class="p-4 space-y-3">
          <input
            type="text"
            id="editor-title"
            placeholder="Title"
            class="w-full text-xl font-semibold outline-none border-b pb-2 mb-2 bg-transparent dark:text-gray-200 border-gray-200 dark:border-gray-600 placeholder-gray-400"
          />
          <textarea
            id="editor-content"
            placeholder="Take a note..."
            class="w-full resize-none outline-none bg-transparent text-gray-700 dark:text-gray-300 placeholder-gray-400"
            style="min-height: 192px"
          ></textarea>
        </div>

        <!-- Editor Action Bar -->
        <div
          class="flex justify-between items-center p-4 border-t border-gray-200 dark:border-gray-700"
        >
          <!-- Color Picker -->
          <div class="flex space-x-2">
            <button
              class="w-6 h-6 rounded-full border-2 border-gray-400 dark:border-gray-200 bg-white dark:bg-gray-800 shadow-sm"
              data-color="white"
              title="No color"
              onclick="setColor('white')"
            ></button>
            <button
              class="w-6 h-6 rounded-full border-2 border-transparent bg-note-yellow shadow-sm"
              data-color="note-yellow"
              title="Yellow"
              onclick="setColor('note-yellow')"
            ></button>
            <button
              class="w-6 h-6 rounded-full border-2 border-transparent bg-note-blue shadow-sm"
              data-color="note-blue"
              title="Blue"
              onclick="setColor('note-blue')"
            ></button>
            <button
              class="w-6 h-6 rounded-full border-2 border-transparent bg-note-green shadow-sm"
              data-color="note-green"
              title="Green"
              onclick="setColor('note-green')"
            ></button>
            <button
              class="w-6 h-6 rounded-full border-2 border-transparent bg-note-red shadow-sm"
              data-color="note-red"
              title="Red"
              onclick="setColor('note-red')"
            ></button>
          </div>

          <!-- Actions and Close -->
          <div class="flex space-x-3">
            <button
              id="archive-btn"
              class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 rounded-full transition-colors"
              title="Archive Note"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 8h14M5 12h14M5 16h14M5 20h14"
                ></path>
              </svg>
            </button>
            <button
              id="delete-btn"
              class="text-gray-500 hover:text-red-500 p-2 rounded-full transition-colors"
              title="Delete Note"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                ></path>
              </svg>
            </button>
            <button
              onclick="closeEditor(true)"
              class="bg-primary text-gray-800 font-semibold py-2 px-4 rounded-full hover:bg-yellow-600 transition duration-200"
            >
              Done
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
      // Toggle user dropdown menu
      document.addEventListener('DOMContentLoaded', function() {
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenu = document.querySelector('[role="menu"]');
        
        if (userMenuButton && userMenu) {
          userMenuButton.addEventListener('click', function() {
            const expanded = this.getAttribute('aria-expanded') === 'true' || false;
            this.setAttribute('aria-expanded', !expanded);
            userMenu.classList.toggle('hidden');
          });
          
          // Close dropdown when clicking outside
          document.addEventListener('click', function(event) {
            if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
              userMenuButton.setAttribute('aria-expanded', 'false');
              userMenu.classList.add('hidden');
            }
          });
        }
        
        // Handle search
        const searchInput = document.getElementById('search-notes');
        if (searchInput) {
          searchInput.addEventListener('input', function(e) {
            searchTerm = e.target.value.toLowerCase();
            renderCurrentView();
          });
        }
      });

      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        addDoc,
        getDoc,
        getDocs,
        setDoc,
        deleteDoc,
        onSnapshot,
        collection,
        query,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Set Firebase logging level to Debug
      setLogLevel("Debug");

      // Global Firebase variables (MANDATORY USE)
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : {};
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      let app,
        db,
        auth,
        userId = null;
      let allNotes = [];
      let currentView = "notes"; // 'notes', 'archive', 'settings'
      let searchTerm = "";
      let darkMode = false; // Global state for dark mode

      // Note data structure
      let currentNote = {
        id: null,
        title: "",
        content: "",
        color: "white",
        archived: false,
      };

      // --- CORE PWA/FIREBASE SETUP ---
      const initFirebase = async () => {
        try {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // Authentication
          onAuthStateChanged(auth, async (user) => {
            if (user) {
              userId = user.uid;
              document.getElementById("current-user-id").textContent = userId;
              document.getElementById("settings-user-id-display").textContent =
                userId;

              // Load user settings (like dark mode)
              await loadUserSettings();

              // Set the initial view right after loading settings
              setView(currentView);

              // Start listening to notes only after authentication is confirmed
              startNotesListener();
            } else {
              // Sign in anonymously if no custom token is provided
              if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
              } else {
                await signInAnonymously(auth);
              }
            }
          });
        } catch (error) {
          console.error("Error initializing Firebase or signing in:", error);
          document.getElementById("loading-message").textContent =
            "Error loading app. See console for details.";
        }
      };

      // --- FIRESTORE DATA & SETTINGS FUNCTIONS ---

      const getNotesCollectionRef = (uid) => {
        // Private data path: /artifacts/{appId}/users/{userId}/notes
        return collection(db, "artifacts", appId, "users", uid, "notes");
      };

      const getSettingsDocRef = (uid) => {
        // Private data path: /artifacts/{appId}/users/{userId}/settings/user_prefs
        return doc(
          db,
          "artifacts",
          appId,
          "users",
          uid,
          "settings",
          "user_prefs"
        );
      };

      const loadUserSettings = async () => {
        if (!userId) return;
        try {
          const settingsDoc = await getDoc(getSettingsDocRef(userId));
          if (settingsDoc.exists()) {
            const data = settingsDoc.data();
            if (typeof data.darkMode === "boolean") {
              darkMode = data.darkMode;
              applyDarkMode(darkMode);
            }
          }
        } catch (error) {
          console.error("Error loading user settings:", error);
        }
      };

      const saveSetting = async (key, value) => {
        if (!userId)
          return console.error("User not authenticated for saving settings.");
        try {
          await setDoc(
            getSettingsDocRef(userId),
            { [key]: value },
            { merge: true }
          );
          console.log(`Setting ${key} saved successfully.`);
        } catch (error) {
          console.error("Error saving setting:", error);
        }
      };

      const startNotesListener = () => {
        if (!userId) return;

        const notesRef = getNotesCollectionRef(userId);
        const q = query(notesRef);

        // Real-time listener for notes
        onSnapshot(
          q,
          (snapshot) => {
            allNotes = []; // Reset global notes array
            snapshot.forEach((doc) => {
              allNotes.push({ id: doc.id, ...doc.data() });
            });

            // Check if the overall collection is empty (regardless of view)
            const loadingMsg = document.getElementById("loading-message");
            if (loadingMsg) {
              loadingMsg.classList.add("hidden");
            }

            // Render the currently active view
            renderCurrentView();
          },
          (error) => {
            console.error("Error fetching notes:", error);
            document.getElementById("loading-message").textContent =
              "Error fetching notes. Check security rules.";
          }
        );
      };

      const saveNote = async (note) => {
        if (!userId) return console.error("User not authenticated.");

        const { id, title, content, color, archived } = note;
        const notesRef = getNotesCollectionRef(userId);

        try {
          // Do not save if both title and content are empty
          if (!title && !content) {
            if (id) deleteNote(id); // Delete empty existing note
            return;
          }

          const data = {
            title,
            content,
            color,
            archived,
            timestamp: serverTimestamp(),
          };

          if (id) {
            // Update existing note
            await setDoc(doc(notesRef, id), data, { merge: true });
          } else {
            // Add new note
            await addDoc(notesRef, data);
          }
          console.log("Note saved successfully.");
        } catch (error) {
          console.error("Error saving note:", error);
        }
      };

      const deleteNote = async (id) => {
        if (!userId || !id) return;
        const notesRef = getNotesCollectionRef(userId);
        try {
          await deleteDoc(doc(notesRef, id));
          showToast("Note deleted");
          console.log("Note deleted successfully.");
        } catch (error) {
          console.error("Error deleting note:", error);
          showToast("Error deleting note", "error");
        }
      };

      // Delete all notes
      const deleteAllNotes = async () => {
        if (!userId) return;

        try {
          const notesRef = getNotesCollectionRef(userId);
          const q = query(notesRef);
          const querySnapshot = await getDocs(q);

          // Delete each note
          const deletePromises = [];
          querySnapshot.forEach((doc) => {
            deletePromises.push(deleteDoc(doc.ref));
          });

          await Promise.all(deletePromises);
          showToast("All notes have been deleted", "success");

          // Update UI
          const deleteMessage = document.getElementById("delete-all-message");
          deleteMessage.textContent = "All notes have been deleted";
          deleteMessage.classList.remove("hidden");

          // Hide the message after 5 seconds
          setTimeout(() => {
            deleteMessage.classList.add("hidden");
          }, 5000);
        } catch (error) {
          console.error("Error deleting notes:", error);
          showToast("Error deleting notes", "error");

          const deleteMessage = document.getElementById("delete-all-message");
          deleteMessage.textContent = "Error deleting notes. Please try again.";
          deleteMessage.classList.remove("hidden");
        }
      };

      // Make deleteAllNotes available globally
      window.deleteAllNotes = deleteAllNotes;

      // Archive a note
      const archiveNote = async (id) => {
        if (!userId || !id) return;
        const notesRef = getNotesCollectionRef(userId);
        try {
          await setDoc(doc(notesRef, id), { archived: true }, { merge: true });
          showToast("Note archived");
          console.log("Note archived successfully.");
        } catch (error) {
          console.error("Error archiving note:", error);
          showToast("Error archiving note", "error");
        }
      };

      // Unarchive a note
      const unarchiveNote = async (id) => {
        if (!userId || !id) return;
        const notesRef = getNotesCollectionRef(userId);
        try {
          await setDoc(doc(notesRef, id), { archived: false }, { merge: true });
          showToast("Note unarchived");
          console.log("Note unarchived successfully.");
        } catch (error) {
          console.error("Error unarchiving note:", error);
          showToast("Error unarchiving note", "error");
        }
      };

      // Show toast notification
      const showToast = (message, type = "success") => {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById("toast-container");
        if (!toastContainer) {
          toastContainer = document.createElement("div");
          toastContainer.id = "toast-container";
          toastContainer.className = "fixed bottom-4 right-4 space-y-2 z-50";
          document.body.appendChild(toastContainer);
        }

        const toast = document.createElement("div");
        const bgColor = type === "error" ? "bg-red-500" : "bg-gray-800";
        toast.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg flex items-center space-x-2 transition-all duration-300 transform translate-x-0 opacity-100`;

        // Add icon based on type
        const iconPath =
          type === "error"
            ? "M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
            : "M5 13l4 4L19 7";

        toast.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path>
          </svg>
          <span>${message}</span>
        `;

        toastContainer.appendChild(toast);

        // Auto-remove after 3 seconds
        setTimeout(() => {
          toast.classList.add("opacity-0", "translate-x-full");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      };

      // --- UI RENDERING & EVENT HANDLERS ---

      const applyDarkMode = (isDark) => {
        const body = document.body;
        const slider = document.getElementById("dark-mode-slider");
        const toggleBtn = document.getElementById("dark-mode-toggle");

        if (isDark) {
          body.classList.add("dark");
          toggleBtn.classList.add("bg-primary");
          toggleBtn.classList.remove("bg-gray-200");
          slider.classList.add("translate-x-5");
          slider.classList.remove("translate-x-0");
          toggleBtn.setAttribute("aria-checked", "true");
        } else {
          body.classList.remove("dark");
          toggleBtn.classList.remove("bg-primary");
          toggleBtn.classList.add("bg-gray-200");
          slider.classList.remove("translate-x-5");
          slider.classList.add("translate-x-0");
          toggleBtn.setAttribute("aria-checked", "false");
        }
      };

      window.toggleDarkMode = () => {
        darkMode = !darkMode;
        applyDarkMode(darkMode);
        saveSetting("darkMode", darkMode);
        // Re-apply color to editor if it's open, as the BG class changes in dark mode
        if (
          !document
            .getElementById("note-editor-modal")
            .classList.contains("hidden")
        ) {
          setColor(currentNote.color);
        }
      };

      window.exportNotes = () => {
        const exportMessage = document.getElementById("export-message");
        exportMessage.classList.remove("hidden", "text-red-600");
        exportMessage.classList.add("text-green-600");

        if (allNotes.length === 0) {
          exportMessage.textContent = "No notes to export.";
          setTimeout(() => exportMessage.classList.add("hidden"), 3000);
          return;
        }

        const dataStr =
          "data:text/json;charset=utf-8," +
          encodeURIComponent(JSON.stringify(allNotes, null, 2));
        const downloadAnchorNode = document.createElement("a");
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute(
          "download",
          `notes_export_${new Date().toISOString().slice(0, 10)}.json`
        );
        document.body.appendChild(downloadAnchorNode); // Required for Firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();

        exportMessage.textContent = `Successfully exported ${allNotes.length} notes.`;
        setTimeout(() => exportMessage.classList.add("hidden"), 3000);
      };

      // Dynamic Textarea Sizing
      const autoResizeTextarea = (textarea) => {
        textarea.style.height = "auto";
        // Set minimum height to 192px (h-48)
        let newHeight = Math.max(textarea.scrollHeight, 192);
        textarea.style.height = newHeight + "px";
      };

      const escapeHTML = (value = "") => {
        return value
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      };

      const formatTimestamp = (timestamp) => {
        if (!timestamp || typeof timestamp.toDate !== "function") return "Draft";
        const date = timestamp.toDate();
        return date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric",
        });
      };

      const updateDashboardStats = () => {
        const active = allNotes.filter((note) => !note.archived).length;
        const archived = allNotes.filter((note) => note.archived).length;
        const total = allNotes.length;

        const activeEl = document.getElementById("stat-active");
        const archivedEl = document.getElementById("stat-archived");
        const totalEl = document.getElementById("stat-total");

        if (activeEl) activeEl.textContent = active;
        if (archivedEl) archivedEl.textContent = archived;
        if (totalEl) totalEl.textContent = total;
      };

      // Expose functions globally for HTML event handlers
      window.setColor = (color) => {
        const card = document.getElementById("editor-card");
        // Remove all existing color classes and add the new one
        card.className = card.className
          .split(" ")
          .filter((c) => !c.startsWith("bg-note-"))
          .join(" ");
        card.classList.remove("bg-white", "bg-dark-card"); // Ensure white/dark background is removable

        if (color === "white") {
          card.classList.add(darkMode ? "bg-dark-card" : "bg-white");
        } else {
          card.classList.add(`bg-${color}`);
        }
        currentNote.color = color;
      };

      window.openEditor = (note = {}) => {
        // Reset editor state
        currentNote = {
          id: note.id || null,
          title: note.title || "",
          content: note.content || "",
          color: note.color || "white",
          archived: note.archived || false,
        };

        // Set modal content
        const editorTitle = document.getElementById("editor-title");
        const editorContent = document.getElementById("editor-content");

        editorTitle.value = currentNote.title;
        editorContent.value = currentNote.content;

        // Apply color to editor modal card
        setColor(currentNote.color);

        // Initial resize for existing content
        setTimeout(() => autoResizeTextarea(editorContent), 0);
        editorContent.oninput = () => autoResizeTextarea(editorContent);

        // Update button actions
        document.getElementById("delete-btn").onclick = () => {
          if (currentNote.id) deleteNote(currentNote.id);
          closeEditor(false); // Close without saving/updating
        };
        document.getElementById("archive-btn").onclick = () => {
          currentNote.archived = currentView === "archive" ? false : true; // Unarchive if in archive view, otherwise archive
          closeEditor(true); // Save and close
        };

        // Update archive button title/icon based on view
        const archiveBtn = document.getElementById("archive-btn");
        if (currentView === "archive") {
          archiveBtn.title = "Unarchive Note";
          archiveBtn.innerHTML =
            '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>'; // Restore/Unarchive icon
        } else {
          archiveBtn.title = "Archive Note";
          archiveBtn.innerHTML =
            '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 12h14M5 16h14M5 20h14"></path></svg>'; // Archive icon
        }

        // Show modal
        document.getElementById("note-editor-modal").classList.remove("hidden");
      };

      window.closeEditor = (shouldSave) => {
        const modal = document.getElementById("note-editor-modal");

        if (shouldSave) {
          currentNote.title = document
            .getElementById("editor-title")
            .value.trim();
          currentNote.content = document
            .getElementById("editor-content")
            .value.trim();

          saveNote(currentNote);
        }

        // Clear inputs and hide modal
        document.getElementById("editor-title").value = "";
        document.getElementById("editor-content").value = "";
        modal.classList.add("hidden");
      };

      // --- VIEW & SEARCH FILTERING ---

      window.setView = (view) => {
        currentView = view;

        // Update active nav item
        document.querySelectorAll("nav a").forEach((link) => {
          link.classList.remove(
            "bg-blue-50",
            "dark:bg-blue-500/10",
            "text-blue-700",
            "dark:text-blue-400"
          );
          link.classList.add("text-gray-700", "dark:text-gray-300");
        });

        const activeLink = document.querySelector(`#nav-${view}`);
        if (activeLink) {
          activeLink.classList.remove("text-gray-700", "dark:text-gray-300");
          activeLink.classList.add(
            "bg-blue-50",
            "dark:bg-blue-500/10",
            "text-blue-700",
            "dark:text-blue-400"
          );
        }

        document
          .querySelectorAll("[data-view-chip]")
          .forEach((chip) =>
            chip.setAttribute(
              "aria-pressed",
              chip.getAttribute("data-view-chip") === view
            )
          );

        const notesIntro = document.getElementById("notes-intro");
        const notesList = document.getElementById("notes-list");
        const settingsContent = document.getElementById("settings-content");
        const statsSection = document.getElementById("notes-stats");

        if (view === "settings") {
          settingsContent.classList.remove("hidden");
          notesList.classList.add("hidden");
          if (notesIntro) notesIntro.classList.add("hidden");
          if (statsSection) statsSection.classList.add("opacity-40");
        } else {
          settingsContent.classList.add("hidden");
          notesList.classList.remove("hidden");
          if (notesIntro)
            notesIntro.classList.toggle("hidden", view !== "notes");
          if (statsSection) statsSection.classList.remove("opacity-40");
        }

        // Update the notes list
        renderCurrentView();
      };

      const renderCurrentView = () => {
        let notesToDisplay = [];

        if (currentView === "settings") {
          updateDashboardStats();
          const noNotesMsg = document.getElementById("no-notes-message");
          if (noNotesMsg) noNotesMsg.classList.add("hidden");
          return;
        }

        if (currentView === "notes") {
          notesToDisplay = allNotes.filter((n) => !n.archived);
        } else if (currentView === "archive") {
          notesToDisplay = allNotes.filter((n) => n.archived);
        }

        // Apply search filter (case-insensitive)
        if (searchTerm) {
          const term = searchTerm.toLowerCase();
          notesToDisplay = notesToDisplay.filter(
            (note) =>
              (note.title && note.title.toLowerCase().includes(term)) ||
              (note.content && note.content.toLowerCase().includes(term))
          );
        }

        updateDashboardStats();

        const noNotesMsg = document.getElementById("no-notes-message");
        if (noNotesMsg) {
          if (currentView === "notes" && allNotes.length === 0) {
            noNotesMsg.classList.remove("hidden");
          } else {
            noNotesMsg.classList.add("hidden");
          }
        }

        renderNotes(notesToDisplay);
      };

      // Filter notes based on current view and search term
      const filterNotes = (notes) => {
        return notes
          .filter((note) => {
            // Skip notes that don't match the current view
            if (currentView === "archive" && !note.archived) return false;
            if (currentView === "notes" && note.archived) return false;

            // Filter by search term if any
            if (searchTerm) {
              const searchLower = searchTerm.toLowerCase();
              const title = (note.title || "").toLowerCase();
              const content = (note.content || "").toLowerCase();
              return (
                title.includes(searchLower) || content.includes(searchLower)
              );
            }

            return true;
          })
          .sort((a, b) => {
            // Sort by timestamp (newest first)
            const timeA = a.timestamp?.toDate()?.getTime() || 0;
            const timeB = b.timestamp?.toDate()?.getTime() || 0;
            return timeB - timeA;
          });
      };

      const renderNotes = (notes) => {
        const notesList = document.getElementById("notes-list");
        if (!notesList) return;

        notesList.innerHTML = "";

        const filteredNotes = filterNotes(notes);

        if (filteredNotes.length === 0) {
          if (allNotes.length === 0) {
            return;
          }
          const emptyMessage = document.createElement("div");
          emptyMessage.className =
            "text-center p-8 text-gray-500 col-span-full backdrop-blur";
          if (currentView === "archive") {
            emptyMessage.textContent = searchTerm
              ? "No archived notes match your search."
              : "No archived notes yet.";
          } else if (searchTerm) {
            emptyMessage.textContent = "No notes match your search.";
          } else {
            emptyMessage.textContent = "No notes found.";
          }
          notesList.appendChild(emptyMessage);
          return;
        }

        filteredNotes.forEach((note) => {
          const noteElement = document.createElement("div");
          const noteDataString = JSON.stringify(note)
            .replace(/'/g, "&#39;")
            .replace(/"/g, "'");

          noteElement.classList.add(
            "note-card",
            "rounded-3xl",
            "border",
            "border-white/70",
            "dark:border-gray-700",
            "shadow-[0_25px_45px_rgba(15,23,42,0.15)]",
            "p-6",
            "space-y-4",
            "backdrop-blur-xl",
            "transition",
            "hover:-translate-y-1",
            "hover:shadow-[0_35px_65px_rgba(15,23,42,0.25)]"
          );

          if (note.color === "white") {
            noteElement.classList.add(
              darkMode ? "bg-dark-card/80" : "bg-white/90"
            );
          } else {
            noteElement.classList.add(`bg-${note.color}`);
          }

          const safeTitle = escapeHTML(note.title || "Untitled Note");
          const rawContent = note.content || "";
          const truncated =
            rawContent.length > 180
              ? `${rawContent.substring(0, 180)}…`
              : rawContent;
          const safeSnippet = escapeHTML(truncated);
          const timestampLabel = formatTimestamp(note.timestamp);
          const archiveAction =
            currentView === "archive" ? "Unarchive" : "Archive";
          const archiveHandler =
            currentView === "archive"
              ? `unarchiveNote('${note.id}')`
              : `archiveNote('${note.id}')`;

          const contentSection = safeSnippet
            ? `<p class="text-base leading-relaxed text-gray-600 dark:text-gray-200">${safeSnippet}</p>`
            : `<p class="text-sm text-gray-400 dark:text-gray-500 italic">No content yet. Tap to add details.</p>`;

          noteElement.innerHTML = `
            <div class="flex items-start justify-between gap-4">
              <div>
                <p class="text-xs uppercase tracking-[0.35em] text-gray-400">${timestampLabel}</p>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mt-2 break-words">${safeTitle}</h3>
              </div>
              <button onclick="event.stopPropagation(); openEditor(${noteDataString})" class="text-gray-500 hover:text-gray-900 dark:hover:text-gray-100 p-2 rounded-full transition-colors" title="Edit">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
            </div>
            ${contentSection}
            <div class="flex items-center justify-between pt-2 text-sm text-gray-500 dark:text-gray-400">
              <span>${note.archived ? "Filed for later" : "In progress"}</span>
              <div class="flex items-center gap-2">
                <button onclick="event.stopPropagation(); ${archiveHandler}" class="rounded-full bg-white/70 dark:bg-gray-800/70 px-4 py-1.5 text-xs font-semibold text-gray-700 dark:text-gray-100 hover:bg-white dark:hover:bg-gray-700 transition" title="${archiveAction}">
                  ${archiveAction}
                </button>
                <button onclick="event.stopPropagation(); if(confirm('Are you sure you want to delete this note?')) { deleteNote('${note.id}'); }" class="p-2 rounded-full text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 transition" title="Delete">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
            </div>
          `;

          noteElement.addEventListener("click", () => openEditor(note));
          notesList.appendChild(noteElement);
        });
      };

      // Add search listener on initial load
      document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("search-input");
        if (searchInput) {
          searchInput.addEventListener("input", (e) => {
            searchTerm = e.target.value;
            renderCurrentView();
          });
        }
      });

      // Initialize the app
      window.onload = () => {
        initFirebase();
      };
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker.register("/service-worker.js").then(
            function (registration) {
              console.log(
                "ServiceWorker registration successful with scope: ",
                registration.scope
              );
            },
            function (err) {
              console.log("ServiceWorker registration failed: ", err);
            }
          );
        });
      }
    </script>

    <!-- Placeholder manifest file -->
    <script type="application/json" id="manifest.json">
      {
        "name": "Note App PWA",
        "short_name": "Notes",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#ffffff",
        "theme_color": "#FFD700",
        "icons": [
          {
            "src": "https://placehold.co/192x192/FFD700/000000?text=N",
            "sizes": "192x192",
            "type": "image/png"
          },
          {
            "src": "https://placehold.co/512x512/FFD700/000000?text=N",
            "sizes": "512x512",
            "type": "image/png"
          }
        ]
      }
    </script>

    <!-- Placeholder Service Worker file -->
    <script type="text/javascript" id="service-worker.js">
      const CACHE_NAME = "notes-pwa-cache-v1";
      const urlsToCache = [
        "/",
        "index.html",
        "https://cdn.tailwindcss.com",
        "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        // Add other static assets here
      ];

      self.addEventListener("install", (event) => {
        event.waitUntil(
          caches.open(CACHE_NAME).then((cache) => {
            console.log("Opened cache");
            return cache.addAll(urlsToCache);
          })
        );
      });

      self.addEventListener("fetch", (event) => {
        event.respondWith(
          caches.match(event.request).then((response) => {
            // Cache hit - return response
            if (response) {
              return response;
            }
            return fetch(event.request);
          })
        );
      });
    </script>
  </body>
</html>
